# This file describes how Crealogix API FIRST works:

## OpenApi 2.0 (swagger 2.0)
API FIRST follows **OpenAPI 2.0** specification. OpenAPI specifications:
	swagger 2.0:
		* [Swagger 2.0](https://swagger.io/docs/specification/2-0/) swagger 2.0
		* [OpenApi 2.0](https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md)
		
## Swagger code generation
The goal of ApiFirst is create a Swagger specification and then generate frontend and backed code from the Swagger specification
 * Frontend: they will generate frontend scaffolding using "API Tools".
 * Backend: swagger-codegen will be used to generate java scaffolding
 
 This document focuses on backend Swagger specification and the Java code generation. For this purpose swagger-codegen-maven-plugin is used: [https://github.com/swagger-api/swagger-codegen/tree/master/modules/swagger-codegen-maven-plugin]

  

## How to generate Swagger specification with swagger codegen

### Env configuration
 * Install node, npm and yarn
 	Linux:
	```bash
	sudo apt install -y nodejs npm
	#add yarn repo
	curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
	echo  "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
	sudo apt -y install yarn
	``` 
	Windows:
	```bash
	npm install --global yarn
	```
	
	

 * Only the fist time, execute the following to install the necessary resources:
	```bash
	npm i -g nodemon (linux)
	npm install -g nodemon (windows)
	```
### Generate specification
 * Check that necessary scripts and tools are on \src\main\resources\swagger:
	```
	 swagger-ui-monitor.sh 
	 swagger-ui-monitor.js
	 package.json
	 live-server.js
	 swagger-ui.html
	 validate_yaml.sh
	 etc
	```

* Edit swagger-ui.html and check that index-combined.yaml is fetched

* Generate OpenApi specification. Execute:

	```bash
	./swagger-ui-monitor.sh.
	```

	This will open new tab in browser with swagger page . For windows install git bash, cygwin or any other bash shell emulator to execute sh scripts:
	
	```bash
	cd <project>\src\main\resources\swagger
	./swagger-ui-monitor.sh
	```
* Opens swagger-ui.html in http://127.0.0.1:9002/ (the port is configurable in live-server.js)
* Modify the OpenApi yaml-s to generate the Swagger specification.

* Execute maven to generate index-combined.yaml 
	```bash
	mvn generate-sources
	```
	 This maven command combines all swagger yaml-s (index.yaml, info/index.yaml, paths/index.yamletc) into a single OpenApi yaml (index-combined.yaml) that can be used as swagger definition. The swagger-ui.html will refresh automatically with the swagger specification changes: http://127.0.0.1:9002/ (swagger-ui.html)

## Validate swagger specification (index-combined.yaml)

* Execute 
	```bash
	./validate_yaml.sh
	```
	This scripts validates that the swagger specification (index-combined.yaml) is correct and there are no errors. After this validation the index-combined.yaml file can be shared with frontend for api tools generation.

  

*  Once validated the swagger specification (index-combined.yaml), this specification must be copied into webapp/static. Copy swagger resources:

* Execute script consolidate.sh which validates and copies to source code the swagger resources (or copy_openapi.bat o copy_openapi.sh for skippping validation of swagger document):
	```bash
	
	./consolidate.sh
	

	#This command copies the resources in webapp/static:
	
	index.json (swagger definition in json format)
	index-combined.yaml (swagger definition in yaml format)
	swagger-ui.html (swagger html to explore index-combined.yaml or index.json)
	index.html (swagger definition in html format)
	```


  

## Java resources autogeneration

The swagger-codegen-maven-plugin generates Java code. 
* Run the "clean package" on pom.xml
	```bash
	cd <pom folder>
	mvn clean package
	```
	This generates Java code on: <project>/target/generated-sources/spring/src/main/java/../
	```
	api/PrivateApi.java -> services generated for /private url-s
	api/PublicApi.java -> services generated for /public url-s
	dto/* -> objects autogenerated by swagger-codegen-maven-plugin
	```
* Remove springfox code with generate. Execute:
	```bash
	cd src/main/resources
	./genereate.sh
	```


## Push changes to git
Before pushing the changes to git make sure all swagger changes are copied to webapp/static:
* Execute: mvn generate-sources -> generates the index-combined.yaml
* Execute: mvn clean package -> generates index.html (plain version of swagger-ui.html)
* Execute: consolidate.sh -> copies swagger resources to webapp/static
 
## Resources
Swagger resources:
1. swagger definition yaml-s:
⋅⋅1. index.yaml
⋅⋅2. info/index.yaml
⋅⋅3. paths/index.yaml
⋅⋅4. definitions/index.yaml
2. index-combined.yaml: Autogenerated yaml